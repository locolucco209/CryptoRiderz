</html>
<!doctype html>
<html lang="en">


<head>
  <title>Top News Stories</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="assets/css/reset.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
  <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>
  <!-- Navbar content -->
  <nav class="pos-f-t">
    <div class="collapse" id="navbarToggleExternalContent">
      <div class="nbar1 p4">
        <!-- <h4 class="text-white">West Coast Riderz</h4> -->
        <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Exchange Rate
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="list.html">Crypto Currency List</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="topnews.html">Top News Stories</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="twitter.html">People to Follow</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="contactUs.html">Contact Us</a>
          </li>
        </ul>
      </div>
    </div>
    <div class="nbar1 navbar navbar-dark">
      <h1 id="appHeader">CryptoFire</h1>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent"
        aria-expanded="flase" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>
  <h2 class="text-center freshTitle">Top News Stories</h2>

  <!-- jQuery -->
  <div id="article-here">
  </div>


  </footer>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
  <script type="text/javascript">



    // displayLatestNews function re-renders the HTML to display the appropriate content
    // function displayLatestNews() {

    var movie = $(this).attr("data-name");
    var queryURL = "https://min-api.cryptocompare.com/data/news/?lang=EN";



    var movie = $(this).attr("data-name");
    var queryURL = "https://min-api.cryptocompare.com/data/news/?lang=EN";


    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBGbVZP7Tw8fVlrJ--JHlvmxFbSPRzEhJo",
      authDomain: "kryptofire-198601.firebaseapp.com",
      databaseURL: "https://kryptofire-198601.firebaseio.com",
      projectId: "kryptofire-198601",
      storageBucket: "kryptofire-198601.appspot.com",
      messagingSenderId: "280838369224"
    };
    firebase.initializeApp(config);
    // Create a variable to reference the database
    var database = firebase.database();

    var LinksCounter = {
      "links": [],
      "count": [],
      "id": []
    }


    database.ref().on("value", function (snapshot) {
      console.log(snapshot.val());
      LinksCounter = snapshot.val().LinksCount;
      updateViewed()
    })

    // Creating an AJAX call
    $.ajax({
      url: queryURL,
      method: "GET"
    }).then(function (response) {

      //
      console.log(response)


      var carddeckDiv = $("<div>")
      carddeckDiv.attr("class", "card-deck")
      $("#article-here").append(carddeckDiv);


      for (i = 0; i < 10; i++) {


        // Creating and storing a div tag
        var newspaperDiv = $("<div>");
        newspaperDiv.attr("class", "card-group mx-auto");

        var Cardmb4Div = $("<div>");
        Cardmb4Div.attr("class", "card  border-secondary mx-auto my-2 p-2")
        Cardmb4Div.attr("style", "width: 20rem")

        var viewoverlay = $("<div>");
        viewoverlay.attr("class", "view overlay")


        var viewoverlay = $("<div>");
        viewoverlay.attr("class", "view overlay")


        var a3 = $("<a>")
        a3.attr("href", response[i].guid)
        a3.attr("target", "_blank")

        var articleImage = $("<img>");
        articleImage.attr("class", "img-fluid image")
        articleImage.attr("alt", "Card image cap")
        articleImage.attr("src", response[i].imageurl)

        var a = $("<a>")
        a.attr("href", "#!")

        var rgbawhite = $("<div>");
        rgbawhite.attr("class", "mask rgba-white-slight")

        var BodyDiv = $("<Div>")
        BodyDiv.attr("class", "card-body)")


        var BodyDiv = $("<Div>")
        BodyDiv.attr("class", "card-body)")


        var a2 = $("<a>")
        a2.attr("href", response[i].guid)
        a2.attr("target", "_blank")
        a2.attr("class", "link")



        var CardTitleDiv = $("<h4>")
        CardTitleDiv.attr("class", "card-title")
        CardTitleDiv.text(response[i].title)

        var p = $("<p>")
        p.attr("class", "card-text")
        p.text(response[i].body.substring(0, 150) + "...")

        var p2 = $("<p>")
        p2.attr("class", "card-text")
        p2.attr("id", response[i].id)

if(LinksCounter.count[i]===undefined){
  LinksCounter.count[i]=""
}
        p2.text("Viewed: " + LinksCounter.count[i])


        var h1 = $("<h5>")
        h1.attr("class", "card-text")
        h1.text(response[i].source)

        // date = date article published
        var date = moment.unix(response[i].published_on).format('MM/DD/YY h:mm A')
        // Current Time
        var currentTime = moment();
        // Difference between the times
        var diffTimeH = moment().diff(date, "hours")
        var diffTimeM = moment().diff(date, "minutes")
        if (diffTimeM > 59) {
          diffTimeM = diffTimeM % 60
        }


        console.log(date + " " + diffTimeH + " h" + diffTimeM + " mn")

        var h2 = $("<p>")
        h2.attr("class", "card-text")
        if (diffTimeH > 0) {
          h2.text(diffTimeH + " hours ago")
        }
        else {
          h2.text(diffTimeM + " minutes ago")
        }


        newspaperDiv.append(Cardmb4Div)
        Cardmb4Div.append(viewoverlay)

        viewoverlay.append(a3)
        a3.append(articleImage)

        viewoverlay.append(a)
        a.append(rgbawhite)
        Cardmb4Div.append(BodyDiv)

        BodyDiv.append(a2)
        a2.append(CardTitleDiv)
        BodyDiv.append(p)
        BodyDiv.append(h1)
        BodyDiv.append(h2)
        BodyDiv.append(p2)

        carddeckDiv.append(newspaperDiv);

      }

      $(".image").click(function () {
        // var parentTag = $( this ).parent().attr('href');
        var parentTag = $( this ).parent().get(0)
        LinksCounter = updateLinkobject(parentTag, response)
        database.ref().set({
          LinksCount: LinksCounter
        });
        console.log(LinksCounter);
      });

      $(".link").click(function () {
        LinksCounter = updateLinkobject(this, response)
        database.ref().set({
          LinksCount: LinksCounter
        });
        console.log(LinksCounter);
      });



      function updateLinkobject(object, response) {
        for (i = 0; i < LinksCounter.links.length; i++) {
          if (LinksCounter.links[i] == object.href) {
            LinksCounter.count[i] = LinksCounter.count[i] + 1
            console.log(LinksCounter)
            return LinksCounter
          }
        }
        LinksCounter.links[i] = object.href
        for (j = 0; j < response.length; j++) {
          if (response[j].guid == object.href) {
            LinksCounter.id[i] = response[j].id
          }

        }
        LinksCounter.count[i] = 1
        //console.log(LinksCount)
        return LinksCounter
      }

     
    })



    function updateViewed() {
      for (i = 0; i < 10; i++) {
        $("#" + LinksCounter.id[i]).text("Viewed: " + LinksCounter.count[i]);
      }

    }

  </script>

</body>

</html>